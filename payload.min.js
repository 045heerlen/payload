/*!
 * Payload.js Javascript Library
 *
 * Copyright (c) 2015, Philip Klauzinski (http://gui.ninja)
 * Released under the MIT license
 * http://www.opensource.org/licenses/mit-license.php
 *
 * @author Philip Klauzinski
 * @version 0.2.4
 * @requires jQuery v1.7+
 * @preserve
 */
!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["jquery"],b):"object"==typeof exports?module.exports=b(require("jquery")):a.Payload=b(a.jQuery)}(this,function(a){"use strict";var b=function(){var b,c,d=this,e={apiCallback:a.noop,apiOnClick:function(){return!0},apiOnSubmit:function(){return!0},apiBeforeRender:a.noop,apiAfterRender:a.noop,apiAccessToken:!1,apiResponseParent:!1,context:document.body,dataNamespace:!1,debug:!1,loadingHtml:"<small>Loading...</small>",loadingDefault:!0,subscribers:[],timeout:!1,xhrAlways:a.noop,xhrBeforeSend:a.noop,xhrDone:a.noop,xhrFail:a.noop},f="data-"+(e.dataNamespace?a.trim(e.dataNamespace)+"-":""),g={API_LINK:"a["+f+"selector],a["+f+"url],button["+f+"selector],button["+f+"url]",API_FORM:"form["+f+"selector],form["+f+"url]",AUTO_LOAD:"["+f+'auto-load="true"]',CLICK:"["+f+"click]",LOADING:"["+f+'role="loading"]'},h={response:{},view:{}},i=["init","apiBeforeRender","apiAfterRender","xhrAlways","xhrBeforeSend","xhrDone","xhrFail"],j=a({}),k=a({}),l=function(a){var b,c;if(e.debug&&"object"==typeof console&&("object"==typeof a||"function"==typeof console[a]))if("object"==typeof a)for(c in a)"function"==typeof console[c]?(b="string"==typeof a[c]||"object"==typeof a[c]&&void 0===a[c].length?[a[c]]:a[c],console[c].apply(console,b)):console.log(a[c]);else console[a].apply(console,Array.prototype.slice.call(arguments,1))},m=function(a){throw"Payload.js: "+a},n=function(){return b=a(e.context),b.length||m('Selector "'+e.context+'" not found'),o(),e.subscribers.length&&d.addSubscribers(e.subscribers),s("init"),d},o=function(){p(),q()},p=function(){b.on("click.api-request auto-load.api-request",g.API_LINK,function(b){var c=a(this);b.preventDefault(),c.prop("disabled")||c.hasClass("disabled")||e.apiOnClick(c,b)&&d.apiRequest(c)}).on("submit.api-request",g.API_FORM,function(b){var c=a(this);b.preventDefault(),e.apiOnSubmit(c,b)&&d.apiRequest(c)})},q=function(){b.on("click.click",g.CLICK,function(b){var c=a(this),d=a(c.attr(f+"click"));b.preventDefault(),d.click()})},r=function(b,d,e){var f,g,i=d.selector,j=a(i);if(!b.closest(i).length){if(h.view[i]){for(f in h.view[i])if(h.view[i].hasOwnProperty(f)&&null===h.view[i][f].html){h.view[i][f].html=j.contents().detach(),g=f;break}}else d.cacheView&&(h.view[i]={});d.cacheView?(h.view[i][e]&&e!==g?h.view[i][e].html=null:h.view[i][e]||(h.view[i][e]={html:null,done:a.noop}),c=e):c=null}},s=function(){j.trigger.apply(j,arguments)},t=function(){j.on.apply(j,arguments)},u=function(){j.off.apply(j,arguments)};this.options=e,this.components={},this.appData={},this.cache=h,this.debug=l,this.deliver=function(a){return"function"==typeof a?e.apiCallback=a:"object"==typeof a?d.merge(a):"string"==typeof a&&(e.context=a),n()},this.merge=function(b){return a.extend(e,b)},this.apiRequest=function(b){var i,j,k,l,m,n,o={href:b.attr("href"),url:b.attr(f+"url")||b.attr("action"),method:(b.attr(f+"method")||b.attr("method")||"get").toLowerCase(),cacheRequest:b.attr(f+"cache-request")||!1,cacheResponse:b.attr(f+"cache-response")||!1,cacheView:b.attr(f+"cache-view")||!1,type:b.attr(f+"type")||"json",selector:b.attr(f+"selector")||!1,template:Handlebars.templates[b.attr(f+"template")]||!1,partial:Handlebars.partials[b.attr(f+"partial")]||!1,events:b.attr(f+"publish")?b.attr(f+"publish").split(" "):[],requestData:a.extend({},d.serializeObject(b),JSON.parse(b.attr(f+"form")||"{}")),timeout:b.attr(f+"timeout")||e.timeout,templateData:{app:d.appData,view:b.data()}},p=function(a,b){for(var c,e=0;e<o.events.length;e++)c=o.events[e],b&&(c+="."+b),d.publish(c,a||[])},q=b.attr(f+"template")||b.attr(f+"partial"),t=o.url+b.serialize();if(o.templateData.request=a.extend({href:o.href,url:o.url,method:o.method,cacheKey:t},o.requestData),(!o.cacheView||c!==q)&&(o.loading=b.attr(f+"loading")?JSON.parse(b.attr(f+"loading")):e.loadingDefault,o.url||o.selector&&(o.template||o.partial))){if(i=a(o.selector),j=b.find("["+f+'role="loading"]'),n={$origin:b,$target:i,api:o},p([n],"pre"),o.cacheView&&h.view[o.selector]&&h.view[o.selector][q]&&null!==h.view[o.selector][q].html?(l=h.view[o.selector][q].html,r(b,o,q),e.apiBeforeRender(n),s("apiBeforeRender",[n]),i.html(l),e.apiAfterRender(n),s("apiAfterRender",[n]),h.view[o.selector][q].done(),o.url=!1):o.url||(e.apiBeforeRender(n),s("apiBeforeRender",[n]),l=o.template?o.template(o.templateData):o.partial(o.templateData),i.html(l),e.apiAfterRender(n),s("apiAfterRender",[n]),r(b,o,q)),e.apiCallback(n),!o.url)return p([n]),void d.triggerAutoLoad(i.find(g.AUTO_LOAD));if(r(b,o,q),o.cacheResponse&&h.response[t]&&h.response[t].data&&h.response[t].done)return m=a.extend({},h.response[t].data,o.templateData),n.response=h.response[t].response,e.apiBeforeRender(n),s("apiBeforeRender",[n]),l=o.template?o.template(m):o.partial(m),i.html(l),e.apiAfterRender(n),s("apiAfterRender",[n]),h.response[t].done(),p([n]),void d.triggerAutoLoad(i.find(g.AUTO_LOAD));i.attr("aria-busy",!0),o.loading?(k=a(e.loadingHtml).attr(f+"role","loading"),i.empty().prepend(k)):j.length&&j.show(),e.apiAccessToken&&(o.requestData.access_token=e.apiAccessToken),a.ajax({url:o.url,type:o.method,dataType:o.type,data:"get"===o.method?o.requestData:JSON.stringify(o.requestData),contentType:"application/json",cache:o.cacheRequest,timeout:o.timeout,beforeSend:function(a,c){var d={jqXHR:a,settings:c,$origin:b,$target:i,api:o};e.apiAccessToken&&a.setRequestHeader("Authorization","Bearer "+e.apiAccessToken),e.xhrBeforeSend(d),s("xhrBeforeSend",[d])}}).done(function(c,f,j){var k=e.apiResponseParent?c[e.apiResponseParent]:c,m=a.extend({},o.templateData,a.isArray(k)?{data:k}:k),n={response:c,status:f,jqXHR:j,$origin:b,$target:i,html:void 0,api:a.extend(o,{templateData:m})},r=function(){e.xhrDone(n),s("xhrDone",[n]),d.triggerAutoLoad(i.find(g.AUTO_LOAD))};i.length&&o.loading?i.find(g.LOADING).first().fadeOut(100,function(){e.apiBeforeRender(n),s("apiBeforeRender",[n]),l=q?o.template?o.template(m):o.partial(m):!1,n.html=l,i.html(l),e.apiAfterRender(n),s("apiAfterRender",[n]),r(),p([n])}):(i.length&&(e.apiBeforeRender(n),s("apiBeforeRender",[n]),l=q?o.template?o.template(m):o.partial(m):!1,n.html=l,i.html(l),e.apiAfterRender(n),s("apiAfterRender",[n])),r(),p([n])),o.cacheResponse?h.response[t]={response:c,data:m,done:r}:o.cacheView&&(h.view[o.selector][q].done=r)}).fail(function(a,c,d){var f={jqXHR:a,status:c,error:d,$origin:b,$target:i,api:o};e.xhrFail(f),s("xhrFail",[f])}).always(function(a,c,d){var f="success"===c,g={response:f?a:null,jqXHR:"success"===c?d:a,status:c,error:f?null:d,$origin:b,$target:i,api:o};e.xhrAlways(g),s("xhrAlways",[g]),i.removeAttr("aria-busy")})}},this.triggerAutoLoad=function(c){void 0!==c?c instanceof a&&c.length&&c.trigger("auto-load"):b.find(g.AUTO_LOAD).trigger("auto-load")},this.publish=function(){l("info",'"'+arguments[0]+'"',"event published."),k.trigger.apply(k,arguments)},this.subscribe=function(){k.on.apply(k,arguments)},this.unsubscribe=function(){k.off.apply(k,arguments)},this.addSubscribers=function(b){a.each(b,function(b,c){c.events&&("string"==typeof c.events&&(c.events=[c.events]),c.methods&&("function"==typeof c.methods&&(c.methods=[c.methods]),a.each(c.events,function(b,e){a.each(c.methods,function(a,b){d.subscribe(e,b)})})))})},this.serializeObject=function(b){var c={},d=b.serializeArray();return a.each(d,function(){void 0!==c[this.name]?(c[this.name].push||(c[this.name]=[c[this.name]]),c[this.name].push(this.value||"")):c[this.name]=this.value||""}),c},this.clearCache=function(a,b){if(void 0===a)h={response:{},view:{}};else if("response"===a)void 0===b?h.response={}:delete h.response[b];else{if("view"!==a)return m("clearCache() - Incorrect type defined");void 0===b?h.view={}:delete h.view[b]}},this.registerComponent=function(a,b){var c=0;if(void 0!==d.components[a])return m('registerComponent() - "'+a+'" component already exists');if(void 0===b)return m('registerComponent() - "'+a+'" component options not defined');for(d.components[a]=b;c<i.length;c++)b[i[c]]&&t(i[c]+"."+a,b[i[c]]);return d.components[a]},this.unregisterComponent=function(a){return void 0===d.components[a]?m('unregisterComponent() - "'+a+'" component does not exist'):(u("."+a),delete d.components[a])}};return new b});