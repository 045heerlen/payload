/*!
 * Payload.js Javascript Library
 *
 * Copyright (c) 2015-2016, Philip Klauzinski (http://gui.ninja)
 * Released under the MIT license
 * http://www.opensource.org/licenses/mit-license.php
 *
 * @author Philip Klauzinski
 * @version 0.3.2
 * @requires jQuery v1.7+
 * @preserve
 */
!function(a,b){"use strict";"function"==typeof define&&define.amd?
// AMD
define(["jquery"],b):"object"==typeof exports?module.exports=b(require("jquery")):a.Payload=b(a.jQuery)}(this,function(a){"use strict";var b=function(){var b,c,d=this,e={apiCallback:a.noop,apiOnClick:function(){return!0},apiOnSubmit:function(){return!0},apiBeforeRender:a.noop,apiAfterRender:a.noop,apiAccessToken:"",apiResponseParent:"",context:document.body,dataNamespace:"",debug:!1,loadingHtml:"<small>Loading...</small>",loadingDefault:!0,partialsNamespace:Handlebars.partials,subscribers:[],// [ {events: [], methods: [] } ]
templatesNamespace:Handlebars.templates,timeout:0,xhrAlways:a.noop,xhrBeforeSend:a.noop,xhrDone:a.noop,xhrFail:a.noop},f="data-"+(e.dataNamespace?a.trim(e.dataNamespace)+"-":""),g={API_LINK:"a["+f+"selector],a["+f+"url],button["+f+"selector],button["+f+"url]",API_FORM:"form["+f+"selector],form["+f+"url]",AUTO_LOAD:"["+f+'auto-load="true"]',CLICK:"["+f+"click]",LOADING:"["+f+'role="loading"]'},h={response:{},view:{}},i=["init","apiBeforeRender","apiAfterRender","xhrAlways","xhrBeforeSend","xhrDone","xhrFail"],j=a({}),k=a({}),/**
             * Safe console debug
             * http://klauzinski.com/javascript/safe-firebug-console-in-javascript
             *
             * @param m
             * @private
             */
l=function(a){var b,c;if(e.debug&&"object"==typeof console&&("object"==typeof a||"function"==typeof console[a]))if("object"==typeof a)for(c in a)"function"==typeof console[c]?(b="string"==typeof a[c]||"object"==typeof a[c]&&void 0===a[c].length?[a[c]]:a[c],console[c].apply(console,b)):console.log(a[c]);else console[a].apply(console,Array.prototype.slice.call(arguments,1))},m=function(a){throw"Payload.js: "+a},/**
             * Publish Payload internal event
             *
             * @private
             */
n=function(){j.trigger.apply(j,arguments)},/**
             * Subscribe to Payload internal event
             *
             * @private
             */
o=function(){j.on.apply(j,arguments)},/**
             * Unsubscribe from Payload internal event
             *
             * @private
             */
p=function(){j.off.apply(j,arguments)},
// Delegation methods
q=function(){b.on("click.api-request auto-load.api-request",g.API_LINK,function(b){var c=a(this);b.preventDefault(),c.prop("disabled")||c.hasClass("disabled")||e.apiOnClick(c,b)&&d.apiRequest(c)}).on("submit.api-request",g.API_FORM,function(b){var c=a(this);b.preventDefault(),e.apiOnSubmit(c,b)&&d.apiRequest(c)})},r=function(){b.on("click.click",g.CLICK,function(b){var c=a(this),d=a(c.attr(f+"click"));b.preventDefault(),d.click()})},s=function(){q(),r()},/**
             * Initialization
             *
             * @returns {Payload}
             * @private
             */
t=function(){return b=a(e.context),b.length||m('Selector "'+e.context+'" not found'),s(),e.subscribers.length&&d.addSubscribers(e.subscribers),n("init"),d},/**
             * Process view caching
             *
             * @param $origin
             * @param api
             * @param templateName
             * @private
             */
u=function(b,d,e){var f,g,i=d.selector,j=a(i);if(!b.closest(i).length){if(h.view[i]){for(f in h.view[i])if(h.view[i].hasOwnProperty(f)&&null===h.view[i][f].html){h.view[i][f].html=j.contents().detach(),g=f;break}}else d.cacheView&&(h.view[i]={});d.cacheView?(h.view[i][e]&&e!==g?h.view[i][e].html=null:h.view[i][e]||(h.view[i][e]={html:null,done:a.noop}),c=e):c=null}};// End private var declaration
/**
         *
         * Public vars and methods
         *
         */
this.options=e,/**
         * Stores registered Payload components and gives public access to them, if needed
         * Additionally, if a component is unregistered, it will be removed from this object
         *
         * @type {{}}
         */
this.components={},/**
         * This object is supplied for storing custom data within your app
         * It is exposed within templates via the "app" namespace
         *
         * @type {{}}
         */
this.appData={},this.cache=h,this.debug=l,/**
         * Deliver Payload API functionality to the specified context
         *
         * @param opts
         */
this.deliver=function(a){return"function"==typeof a?e.apiCallback=a:"object"==typeof a?d.merge(a):"string"==typeof a&&(e.context=a),t()},/**
         * Merge the current options with the given new options
         *
         * @param opts
         * @returns {*}
         */
this.merge=function(b){return a.extend(e,b)},/**
         * Make an API request via the given jQuery $origin object
         * This method is called internally when a Payload API object is interacted with in the DOM
         * It may also be called directly by supplying any jQuery object with the appropriate attributes
         *
         * @param $origin
         * @todo - break this up into more granular methods
         */
this.apiRequest=function(b){var i,j,k,l,m,o,p,q={href:b.attr("href"),url:b.attr(f+"url")||b.attr("action"),method:(b.attr(f+"method")||b.attr("method")||"get").toLowerCase(),cacheRequest:b.attr(f+"cache-request")||!1,cacheResponse:b.attr(f+"cache-response")||!1,cacheView:b.attr(f+"cache-view")||!1,type:b.attr(f+"type")||"json",selector:b.attr(f+"selector")||!1,template:e.templatesNamespace[b.attr(f+"template")]||!1,partial:e.partialsNamespace[b.attr(f+"partial")]||!1,events:b.attr(f+"publish")?b.attr(f+"publish").split(" "):[],requestData:a.extend({},d.serializeObject(b),JSON.parse(b.attr(f+"form")||"{}")),timeout:b.attr(f+"timeout")||e.timeout,templateData:{app:d.appData,view:b.data()}},r=function(a,b){for(var c,e=0;e<q.events.length;e++)c=q.events[e],b&&(c+="."+b),d.publish(c,a||[])},s=b.attr(f+"template")||b.attr(f+"partial");
// If caching is invoked and this is the last template loaded, do nothing
if(
// Add the request payload to the template data under "request" namespace
q.templateData.request=a.extend({href:q.href,url:q.url,method:q.method,cacheKey:q.url+b.serialize()},q.requestData),i=q.templateData.request,(!q.cacheView||c!==s)&&(q.loading=b.attr(f+"loading")?JSON.parse(b.attr(f+"loading")):e.loadingDefault,q.url||q.selector&&(q.template||q.partial))){if(j=a(q.selector),k=b.find("["+f+'role="loading"]'),p={$origin:b,$target:j,api:q},r([p],"pre"),q.cacheView&&h.view[q.selector]&&h.view[q.selector][s]&&null!==h.view[q.selector][s].html?(m=h.view[q.selector][s].html,u(b,q,s),e.apiBeforeRender(p),n("apiBeforeRender",[p]),j.html(m),e.apiAfterRender(p),n("apiAfterRender",[p]),h.view[q.selector][s].done(),q.url=!1):q.url||(e.apiBeforeRender(p),n("apiBeforeRender",[p]),m=q.template?q.template(q.templateData):q.partial(q.templateData),j.html(m),e.apiAfterRender(p),n("apiAfterRender",[p]),u(b,q,s)),e.apiCallback(p),!q.url)return r([p]),void d.triggerAutoLoad(j.find(g.AUTO_LOAD));if(u(b,q,s),q.cacheResponse&&h.response[i.cacheKey]&&h.response[i.cacheKey].data&&h.response[i.cacheKey].done)return o=a.extend({},h.response[i.cacheKey].data,q.templateData),p.response=h.response[i.cacheKey].response,e.apiBeforeRender(p),n("apiBeforeRender",[p]),m=q.template?q.template(o):q.partial(o),j.html(m),e.apiAfterRender(p),n("apiAfterRender",[p]),h.response[i.cacheKey].done(),r([p]),void d.triggerAutoLoad(j.find(g.AUTO_LOAD));
// Begin AJAX sequence
// Set selector as busy, and show loading indicator if available
j.attr("aria-busy",!0),q.loading?(l=a(e.loadingHtml).attr(f+"role","loading"),j.empty().prepend(l)):k.length&&k.show(),
// Is there an access token?
e.apiAccessToken&&(q.requestData.access_token=e.apiAccessToken),a.ajax({url:q.url,type:q.method,dataType:q.type,data:"get"===q.method?q.requestData:JSON.stringify(q.requestData),contentType:"application/json",cache:q.cacheRequest,timeout:q.timeout,beforeSend:function(a,c){var d={jqXHR:a,settings:c,$origin:b,$target:j,api:q};e.apiAccessToken&&a.setRequestHeader("Authorization","Bearer "+e.apiAccessToken),e.xhrBeforeSend(d),n("xhrBeforeSend",[d])}}).done(function(c,f,k){var l=e.apiResponseParent?c[e.apiResponseParent]:c,o=a.extend({},q.templateData,a.isArray(l)?{data:l}:l),p={response:c,status:f,jqXHR:k,$origin:b,$target:j,html:void 0,// filled in below after HTML is rendered
api:a.extend(q,{templateData:o})},t=function(){e.xhrDone(p),n("xhrDone",[p]),d.triggerAutoLoad(j.find(g.AUTO_LOAD))};j.length&&q.loading?j.find(g.LOADING).first().fadeOut(100,function(){e.apiBeforeRender(p),n("apiBeforeRender",[p]),m=s?q.template?q.template(o):q.partial(o):!1,p.html=m,j.html(m),e.apiAfterRender(p),n("apiAfterRender",[p]),t(),r([p])}):(j.length&&(e.apiBeforeRender(p),n("apiBeforeRender",[p]),m=s?q.template?q.template(o):q.partial(o):!1,p.html=m,j.html(m),e.apiAfterRender(p),n("apiAfterRender",[p])),t(),r([p])),q.cacheResponse?h.response[i.cacheKey]={response:c,data:o,done:t}:q.cacheView&&(h.view[q.selector][s].done=t)}).fail(function(a,c,d){var f={jqXHR:a,status:c,error:d,$origin:b,$target:j,api:q};e.xhrFail(f),n("xhrFail",[f])}).always(function(a,c,d){var f="success"===c,g={response:f?a:null,jqXHR:"success"===c?d:a,status:c,error:f?null:d,$origin:b,$target:j,api:q};e.xhrAlways(g),n("xhrAlways",[g]),
// Remove selector busy status
j.removeAttr("aria-busy")})}},/**
         * Trigger the 'auto-load' event on given jQuery object
         * When no argument is passed, trigger 'auto-load' if found within the app context
         *
         * @param $e
         */
this.triggerAutoLoad=function(c){void 0!==c?c instanceof a&&c.length&&c.trigger("auto-load"):b.find(g.AUTO_LOAD).trigger("auto-load")},/**
         * Publish a custom event
         * based on https://github.com/cowboy/jquery-tiny-pubsub
         */
this.publish=function(){l("info",'"'+arguments[0]+'"',"event published."),k.trigger.apply(k,arguments)},/**
         * Subscribe to a custom event
         * based on https://github.com/cowboy/jquery-tiny-pubsub
         */
this.subscribe=function(){k.on.apply(k,arguments)},/**
         * Unsubscribe from a custom event
         * based on https://github.com/cowboy/jquery-tiny-pubsub
         */
this.unsubscribe=function(){k.off.apply(k,arguments)},/**
         * Subscribe custom events to given methods in array of {events: [], methods: [] } objects
         *
         * @param subscribers
         * @public
         */
this.addSubscribers=function(b){a.each(b,function(b,c){c.events&&("string"==typeof c.events&&(c.events=[c.events]),c.methods&&("function"==typeof c.methods&&(c.methods=[c.methods]),a.each(c.events,function(b,e){a.each(c.methods,function(a,b){d.subscribe(e,b)})})))})},/**
         * Convert given form input data to an object
         *
         * @param $form
         * @returns {{}}
         */
this.serializeObject=function(b){var c={},d=b.serializeArray();return a.each(d,function(){void 0!==c[this.name]?(c[this.name].push||(c[this.name]=[c[this.name]]),c[this.name].push(this.value||"")):c[this.name]=this.value||""}),c},/**
         * Clear cache of specified type ('response' or 'view') and optionally a single key
         * To clear all cache, pass no parameters
         *
         * @param type
         * @param key
         */
this.clearCache=function(a,b){if(void 0===a)h={response:{},view:{}};else if("response"===a)void 0===b?h.response={}:delete h.response[b];else{if("view"!==a)return m("clearCache() - Incorrect type defined");void 0===b?h.view={}:delete h.view[b]}},/**
         * Register a Payload component by supplying the name (str) and options (obj)
         *
         * @param name
         * @param options
         * @returns {*}
         */
this.registerComponent=function(a,b){var c=0;if(void 0!==d.components[a])return m('registerComponent() - "'+a+'" component already exists');if(void 0===b)return m('registerComponent() - "'+a+'" component options not defined');for(d.components[a]=b;c<i.length;c++)b[i[c]]&&o(i[c]+"."+a,b[i[c]]);return d.components[a]},/**
         * Unregister a previously registered component by supplying the name (str)
         *
         * @param name
         * @returns {boolean}
         */
this.unregisterComponent=function(a){return void 0===d.components[a]?m('unregisterComponent() - "'+a+'" component does not exist'):(p("."+a),delete d.components[a])}};return new b});