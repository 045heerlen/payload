/*!
 * Payload.js Javascript Library
 *
 * Copyright (c) 2015, Philip Klauzinski (http://gui.ninja)
 * Released under the MIT license
 * http://www.opensource.org/licenses/mit-license.php
 *
 * @author Philip Klauzinski
 * @version 0.2.6
 * @requires jQuery v1.7+
 * @preserve
 */
!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["jquery"],b):"object"==typeof exports?module.exports=b(require("jquery")):a.Payload=b(a.jQuery)}(this,function(a){"use strict";var b=function(){var b,c,d=this,e={apiCallback:a.noop,apiOnClick:function(){return!0},apiOnSubmit:function(){return!0},apiBeforeRender:a.noop,apiAfterRender:a.noop,apiAccessToken:!1,apiResponseParent:!1,context:document.body,dataNamespace:!1,debug:!1,loadingHtml:"<small>Loading...</small>",loadingDefault:!0,subscribers:[],timeout:!1,xhrAlways:a.noop,xhrBeforeSend:a.noop,xhrDone:a.noop,xhrFail:a.noop},f="data-"+(e.dataNamespace?a.trim(e.dataNamespace)+"-":""),g={API_LINK:"a["+f+"selector],a["+f+"url],button["+f+"selector],button["+f+"url]",API_FORM:"form["+f+"selector],form["+f+"url]",AUTO_LOAD:"["+f+'auto-load="true"]',CLICK:"["+f+"click]",LOADING:"["+f+'role="loading"]'},h={response:{},view:{}},i=["init","apiBeforeRender","apiAfterRender","xhrAlways","xhrBeforeSend","xhrDone","xhrFail"],j=a({}),k=a({}),l=function(a){var b,c;if(e.debug&&"object"==typeof console&&("object"==typeof a||"function"==typeof console[a]))if("object"==typeof a)for(c in a)"function"==typeof console[c]?(b="string"==typeof a[c]||"object"==typeof a[c]&&void 0===a[c].length?[a[c]]:a[c],console[c].apply(console,b)):console.log(a[c]);else console[a].apply(console,Array.prototype.slice.call(arguments,1))},m=function(a){throw"Payload.js: "+a},n=function(){return b=a(e.context),b.length||m('Selector "'+e.context+'" not found'),o(),e.subscribers.length&&d.addSubscribers(e.subscribers),s("init"),d},o=function(){p(),q()},p=function(){b.on("click.api-request auto-load.api-request",g.API_LINK,function(b){var c=a(this);b.preventDefault(),c.prop("disabled")||c.hasClass("disabled")||e.apiOnClick(c,b)&&d.apiRequest(c)}).on("submit.api-request",g.API_FORM,function(b){var c=a(this);b.preventDefault(),e.apiOnSubmit(c,b)&&d.apiRequest(c)})},q=function(){b.on("click.click",g.CLICK,function(b){var c=a(this),d=a(c.attr(f+"click"));b.preventDefault(),d.click()})},r=function(b,d,e){var f,g,i=d.selector,j=a(i);if(!b.closest(i).length){if(h.view[i]){for(f in h.view[i])if(h.view[i].hasOwnProperty(f)&&null===h.view[i][f].html){h.view[i][f].html=j.contents().detach(),g=f;break}}else d.cacheView&&(h.view[i]={});d.cacheView?(h.view[i][e]&&e!==g?h.view[i][e].html=null:h.view[i][e]||(h.view[i][e]={html:null,done:a.noop}),c=e):c=null}},s=function(){j.trigger.apply(j,arguments)},t=function(){j.on.apply(j,arguments)},u=function(){j.off.apply(j,arguments)};this.options=e,this.components={},this.appData={},this.cache=h,this.debug=l,this.deliver=function(a){return"function"==typeof a?e.apiCallback=a:"object"==typeof a?d.merge(a):"string"==typeof a&&(e.context=a),n()},this.merge=function(b){return a.extend(e,b)},this.apiRequest=function(b){var i,j,k,l,m,n,o,p={href:b.attr("href"),url:b.attr(f+"url")||b.attr("action"),method:(b.attr(f+"method")||b.attr("method")||"get").toLowerCase(),cacheRequest:b.attr(f+"cache-request")||!1,cacheResponse:b.attr(f+"cache-response")||!1,cacheView:b.attr(f+"cache-view")||!1,type:b.attr(f+"type")||"json",selector:b.attr(f+"selector")||!1,template:Handlebars.templates[b.attr(f+"template")]||!1,partial:Handlebars.partials[b.attr(f+"partial")]||!1,events:b.attr(f+"publish")?b.attr(f+"publish").split(" "):[],requestData:a.extend({},d.serializeObject(b),JSON.parse(b.attr(f+"form")||"{}")),timeout:b.attr(f+"timeout")||e.timeout,templateData:{app:d.appData,view:b.data()}},q=function(a,b){for(var c,e=0;e<p.events.length;e++)c=p.events[e],b&&(c+="."+b),d.publish(c,a||[])},t=b.attr(f+"template")||b.attr(f+"partial");if(p.templateData.request=a.extend({href:p.href,url:p.url,method:p.method,cacheKey:p.url+b.serialize()},p.requestData),i=p.templateData.request,(!p.cacheView||c!==t)&&(p.loading=b.attr(f+"loading")?JSON.parse(b.attr(f+"loading")):e.loadingDefault,p.url||p.selector&&(p.template||p.partial))){if(j=a(p.selector),k=b.find("["+f+'role="loading"]'),o={$origin:b,$target:j,api:p},q([o],"pre"),p.cacheView&&h.view[p.selector]&&h.view[p.selector][t]&&null!==h.view[p.selector][t].html?(m=h.view[p.selector][t].html,r(b,p,t),e.apiBeforeRender(o),s("apiBeforeRender",[o]),j.html(m),e.apiAfterRender(o),s("apiAfterRender",[o]),h.view[p.selector][t].done(),p.url=!1):p.url||(e.apiBeforeRender(o),s("apiBeforeRender",[o]),m=p.template?p.template(p.templateData):p.partial(p.templateData),j.html(m),e.apiAfterRender(o),s("apiAfterRender",[o]),r(b,p,t)),e.apiCallback(o),!p.url)return q([o]),void d.triggerAutoLoad(j.find(g.AUTO_LOAD));if(r(b,p,t),p.cacheResponse&&h.response[i.cacheKey]&&h.response[i.cacheKey].data&&h.response[i.cacheKey].done)return n=a.extend({},h.response[i.cacheKey].data,p.templateData),o.response=h.response[i.cacheKey].response,e.apiBeforeRender(o),s("apiBeforeRender",[o]),m=p.template?p.template(n):p.partial(n),j.html(m),e.apiAfterRender(o),s("apiAfterRender",[o]),h.response[i.cacheKey].done(),q([o]),void d.triggerAutoLoad(j.find(g.AUTO_LOAD));j.attr("aria-busy",!0),p.loading?(l=a(e.loadingHtml).attr(f+"role","loading"),j.empty().prepend(l)):k.length&&k.show(),e.apiAccessToken&&(p.requestData.access_token=e.apiAccessToken),a.ajax({url:p.url,type:p.method,dataType:p.type,data:"get"===p.method?p.requestData:JSON.stringify(p.requestData),contentType:"application/json",cache:p.cacheRequest,timeout:p.timeout,beforeSend:function(a,c){var d={jqXHR:a,settings:c,$origin:b,$target:j,api:p};e.apiAccessToken&&a.setRequestHeader("Authorization","Bearer "+e.apiAccessToken),e.xhrBeforeSend(d),s("xhrBeforeSend",[d])}}).done(function(c,f,k){var l=e.apiResponseParent?c[e.apiResponseParent]:c,n=a.extend({},p.templateData,a.isArray(l)?{data:l}:l),o={response:c,status:f,jqXHR:k,$origin:b,$target:j,html:void 0,api:a.extend(p,{templateData:n})},r=function(){e.xhrDone(o),s("xhrDone",[o]),d.triggerAutoLoad(j.find(g.AUTO_LOAD))};j.length&&p.loading?j.find(g.LOADING).first().fadeOut(100,function(){e.apiBeforeRender(o),s("apiBeforeRender",[o]),m=t?p.template?p.template(n):p.partial(n):!1,o.html=m,j.html(m),e.apiAfterRender(o),s("apiAfterRender",[o]),r(),q([o])}):(j.length&&(e.apiBeforeRender(o),s("apiBeforeRender",[o]),m=t?p.template?p.template(n):p.partial(n):!1,o.html=m,j.html(m),e.apiAfterRender(o),s("apiAfterRender",[o])),r(),q([o])),p.cacheResponse?h.response[i.cacheKey]={response:c,data:n,done:r}:p.cacheView&&(h.view[p.selector][t].done=r)}).fail(function(a,c,d){var f={jqXHR:a,status:c,error:d,$origin:b,$target:j,api:p};e.xhrFail(f),s("xhrFail",[f])}).always(function(a,c,d){var f="success"===c,g={response:f?a:null,jqXHR:"success"===c?d:a,status:c,error:f?null:d,$origin:b,$target:j,api:p};e.xhrAlways(g),s("xhrAlways",[g]),j.removeAttr("aria-busy")})}},this.triggerAutoLoad=function(c){void 0!==c?c instanceof a&&c.length&&c.trigger("auto-load"):b.find(g.AUTO_LOAD).trigger("auto-load")},this.publish=function(){l("info",'"'+arguments[0]+'"',"event published."),k.trigger.apply(k,arguments)},this.subscribe=function(){k.on.apply(k,arguments)},this.unsubscribe=function(){k.off.apply(k,arguments)},this.addSubscribers=function(b){a.each(b,function(b,c){c.events&&("string"==typeof c.events&&(c.events=[c.events]),c.methods&&("function"==typeof c.methods&&(c.methods=[c.methods]),a.each(c.events,function(b,e){a.each(c.methods,function(a,b){d.subscribe(e,b)})})))})},this.serializeObject=function(b){var c={},d=b.serializeArray();return a.each(d,function(){void 0!==c[this.name]?(c[this.name].push||(c[this.name]=[c[this.name]]),c[this.name].push(this.value||"")):c[this.name]=this.value||""}),c},this.clearCache=function(a,b){if(void 0===a)h={response:{},view:{}};else if("response"===a)void 0===b?h.response={}:delete h.response[b];else{if("view"!==a)return m("clearCache() - Incorrect type defined");void 0===b?h.view={}:delete h.view[b]}},this.registerComponent=function(a,b){var c=0;if(void 0!==d.components[a])return m('registerComponent() - "'+a+'" component already exists');if(void 0===b)return m('registerComponent() - "'+a+'" component options not defined');for(d.components[a]=b;c<i.length;c++)b[i[c]]&&t(i[c]+"."+a,b[i[c]]);return d.components[a]},this.unregisterComponent=function(a){return void 0===d.components[a]?m('unregisterComponent() - "'+a+'" component does not exist'):(u("."+a),delete d.components[a])}};return new b});